**累计布局偏移（Cumulative Layout Shift，简称 CLS）** 是 Google 提出的 **Core Web Vitals（核心网页指标）** 之一，用于衡量网页在加载过程中**视觉稳定性**的一个关键性能指标。

[累计布局偏移](https://vercel.com/blog/how-core-web-vitals-affect-seo)是谷歌用来评估网站性能和用户体验的指标。对于字体来说，**排版变换**是指**浏览器最初用备用字体或系统字体渲染文本，加载完成后再替换为自定义字体**。这种变换会导致文本大小、间距或布局发生变化，从而改变周围的元素。
Next.js 在使用 `Next/font` 模块时会自动优化应用程序中的字体。它在**构建时下载字体文件，并将其与你的其他静态资产一起托管**。这意味着当用户访问你的应用时，不会有额外的网络字体请求，这会影响性能。


---

### 🎯 一、CLS 是什么？

> **CLS 衡量的是：页面在加载过程中，非预期的、突然发生的元素位移（“跳动”）的总和。**

例如：

- 你正要点击一个按钮，它突然下移了 → 点错地方！
- 文字刚读到一半，图片加载出来把内容往下推 → 阅读体验被打断！

这些都属于 **不良的布局偏移（Layout Shift）**，会降低用户体验。

---

### 📊 二、CLS 如何计算？

每次发生布局偏移时，会计算一个 **Layout Shift Score（偏移分数）**：

```
Layout Shift Score = 影响分数（Impact Fraction） × 距离分数（Distance Fraction）
```

#### 1. **影响分数（Impact Fraction）**

- 指**视口内**因元素移动而**发生变化的区域比例**。
- 例如：一个大图突然出现，把下面内容推下去，那么“被覆盖 + 新出现”的区域占屏幕的比例就是影响分数。

#### 2. **距离分数（Distance Fraction）**

- 指元素**移动的距离**占视口宽度或高度的最大比例。
- 例如：一个按钮向下移动了 20px，在 100px 高的视口中，距离分数 = 20 / 100 = 0.2。

#### ✅ 累计（Cumulative）

- 页面生命周期中所有**非预期**的布局偏移分数会**累加**，得到最终的 CLS 值。
- **值越小越好**。

---

### 📏 三、CLS 评分标准（Google）

|CLS 值|用户体验|评级|
|---|---|---|
|**0 – 0.1**|良好（Good）|✅|
|**0.1 – 0.25**|需要改进（Needs Improvement）|⚠️|
|抗|**> 0.25**|差（Poor）|

> 💡 目标：**CLS ≤ 0.1**

---

### 🧨 四、常见导致高 CLS 的原因

| 原因                  | 示例                                    | 解决方案                                           |
| ------------------- | ------------------------------------- | ---------------------------------------------- |
| **未指定尺寸的图片/视频**     | `<img src="...">` 没有 `width`/`height` | 始终设置 `width` 和 `height`，或使用 CSS `aspect-ratio` |
| **动态插入内容**          | 广告、弹窗、通知在顶部/中间突然出现                    | 预留占位空间（如用 `min-height`）                        |
| **字体闪现（FOIT/FOUT）** | 自定义字体加载慢，先显示 fallback 字体，再切换          | 使用 `font-display: swap` + 预加载字体                |
| **异步加载的组件**         | 评论区、推荐模块通过 JS 加载后插入 DOM               | 提前预留容器高度，或使用骨架屏（Skeleton）                      |
| **CSS 动画/媒体查询触发重排** | 某些响应式规则导致元素尺寸突变                       | 避免在关键内容上使用可能引起布局变化的动画                          |

---

### ✅ 五、如何优化 CLS？

#### 1. **为图片和视频设置明确尺寸**

```html
<!-- ✅ 好 -->
<img src="photo.jpg" width="640" height="360" alt="..." />

<!-- 或用 CSS -->
<img src="photo.jpg" style="aspect-ratio: 16/9; width: 100%;" />
```

#### 2. **为广告、嵌入内容预留空间**

```css
.ad-container {
  min-height: 250px; /* 预留高度 */
  background: #f5f5f5;
}
```

#### 3. **避免在现有内容上方插入新内容**

- 除非用户主动触发（如点击“加载更多”）
- 否则应追加到末尾，或使用固定位置（如 toast 通知）

#### 4. **使用 `transform` 做动画，而非改变布局属性**

```css
/* ❌ 会触发重排 */
.box { width: 100px; }
.box:hover { width: 200px; }

/* ✅ 只触发合成，不重排 */
.box { transform: scale(1); }
.box:hover { transform: scale(1.2); }
```

#### 5. **预加载关键资源**

```html
<link rel="preload" href="font.woff2" as="font" type="font/woff2" crossorigin>
```

---

### 🔍 六、如何测量 CLS？

#### 开发阶段：

- **Chrome DevTools** → Lighthouse 报告
- **Web Vitals Chrome 扩展**
- 使用 `web-vitals` JS 库：
    
    ```js
    import { getCLS } from 'web-vitals';
    getCLS(console.log); // 输出当前页面 CLS
    ```
    

#### 线上监控：

- Google Search Console（核心 Web 指标报告）
- 第三方监控工具（如 Sentry、LogRocket、Datadog）

---

### 🌐 七、CLS 与 SEO 的关系

Google **将 CLS 作为搜索排名因子之一**。  
高 CLS（布局不稳定）会被视为**低质量用户体验**，可能导致：

- 搜索排名下降
- 用户跳出率升高

---

### ✅ 总结

|关键点|说明|
|---|---|
|**CLS 是什么**|衡量页面加载时“元素乱跳”的程度|
|**目标值**|≤ 0.1|
|**核心原则**|**提前预留空间，避免内容突然出现或移动**|
|**优化重点**|图片尺寸、字体加载、动态内容占位|

> 💡 记住：**稳定的布局 = 更好的用户体验 = 更好的 SEO 和转化率**

如果你有具体页面 CLS 高的问题，也可以提供场景，我可以帮你分析优化方案！


